generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(cuid())
  email         String         @unique
  password      String
  firstName     String
  lastName      String
  dateOfBirth   DateTime?
  city          String?
  country       String?
  phone         String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  address       String?
  emailVerified Boolean        @default(false)
  lastLoginAt   DateTime?
  postalCode    String?
  role          UserRole       @default(USER)
  status        UserStatus     @default(ACTIVE)
  auditLogs     AuditLog[]
  certificates  Certificate[]
  licenses      License[]
  notifications Notification[]
  payments      Payment[]
  rapidTests    RapidTest[]
  testKits      TestKit[]
}

model TestKit {
  id             String        @id @default(cuid())
  serialNumber   String        @unique
  type           TestKitType
  manufacturer   String
  model          String
  batchNumber    String
  expirationDate DateTime
  status         TestKitStatus @default(AVAILABLE)
  userId         String?
  purchasedAt    DateTime?
  usedAt         DateTime?
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  rapidTests     RapidTest[]
  user           User?         @relation(fields: [userId], references: [id])
}

model RapidTest {
  id             String        @id @default(cuid())
  userId         String
  testDate       DateTime
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  licenseId      String?
  completedAt    DateTime?
  notes          String?
  resultImageUrl String?
  testKitId      String
  status         TestStatus    @default(PENDING)
  result         TestResult?
  videoUrl       String?
  photoUrl       String?
  testDeviceUrl  String?
  agreementGiven Boolean       @default(false)
  identityCard1Url String?
  identityCard2Url String?
  identityCardId String?
  certificates   Certificate[]
  license        License?      @relation(fields: [licenseId], references: [id])
  testKit        TestKit       @relation(fields: [testKitId], references: [id])
  user           User          @relation(fields: [userId], references: [id])
}

model License {
  id            String        @id @default(cuid())
  userId        String
  maxUses       Int
  usesCount     Int           @default(0)
  expiresAt     DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  licenseKey    String        @unique
  revokedAt     DateTime?
  revokedReason String?
  status        LicenseStatus @default(ACTIVE)
  description   String?
  user          User          @relation(fields: [userId], references: [id])
  rapidTests    RapidTest[]
}

model Payment {
  id            String        @id @default(cuid())
  userId        String
  amount        Float
  currency      String
  transactionId String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  completedAt   DateTime?
  description   String?
  failureReason String?
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  user          User          @relation(fields: [userId], references: [id])
}

model Certificate {
  id                String            @id @default(cuid())
  userId            String
  rapidTestId       String
  type              CertificateType
  status            CertificateStatus @default(DRAFT)
  certificateNumber String            @unique
  issuedAt          DateTime
  validFrom         DateTime
  validUntil        DateTime
  qrCodeUrl         String?
  pdfUrl            String?
  language          String?           @default("en")
  revokedAt         DateTime?
  revokedReason     String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  rapidTest         RapidTest         @relation(fields: [rapidTestId], references: [id])
  user              User              @relation(fields: [userId], references: [id])
}

model AuditLog {
  id          String          @id @default(cuid())
  userId      String
  action      AuditAction
  entityType  AuditEntityType
  entityId    String?
  oldValues   String?
  newValues   String?
  ipAddress   String?
  userAgent   String?
  description String?
  createdAt   DateTime        @default(now())
  user        User            @relation(fields: [userId], references: [id])
}

model Notification {
  id         String               @id @default(cuid())
  userId     String
  type       NotificationType
  status     NotificationStatus   @default(UNREAD)
  priority   NotificationPriority @default(MEDIUM)
  title      String
  message    String
  data       String?
  readAt     DateTime?
  archivedAt DateTime?
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt
  user       User                 @relation(fields: [userId], references: [id])
}

model LegalPage {
  id        String          @id @default(cuid())
  type      LegalPageType
  title     String
  content   String
  language  String          @default("de")
  version   String          @default("1.0")
  isActive  Boolean         @default(true)
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@unique([type, language])
}

enum LegalPageType {
  PRIVACY_POLICY
  TERMS_CONDITIONS
  IMPRESSUM
  COOKIE_POLICY
}

enum UserRole {
  ADMIN
  USER
  MODERATOR
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum TestKitType {
  COVID_19
  FLU
  STREP_THROAT
  PREGNANCY
  DRUG_TEST
}

enum TestKitStatus {
  AVAILABLE
  USED
  EXPIRED
  DAMAGED
}

enum TestStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum TestResult {
  POSITIVE
  NEGATIVE
  INVALID
  INCONCLUSIVE
}

enum LicenseStatus {
  ACTIVE
  EXPIRED
  REVOKED
  SUSPENDED
}

enum PaymentMethod {
  CREDIT_CARD
  PAYPAL
  BANK_TRANSFER
  CRYPTO
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum CertificateType {
  TEST_RESULT
  VACCINATION
  RECOVERY
  MEDICAL_CLEARANCE
}

enum CertificateStatus {
  DRAFT
  ISSUED
  EXPIRED
  REVOKED
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  VIEW
  EXPORT
}

enum AuditEntityType {
  USER
  RAPID_TEST
  TEST_KIT
  PAYMENT
  CERTIFICATE
  LICENSE
}

enum NotificationType {
  TEST_RESULT
  CERTIFICATE_READY
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  SYSTEM_UPDATE
  SECURITY_ALERT
}

enum NotificationStatus {
  UNREAD
  READ
  ARCHIVED
}

enum NotificationPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}
